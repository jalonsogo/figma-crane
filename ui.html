<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/figma-plugin-ds.css">
<style>
  body {
    padding: 0;
    margin: 0;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
  }
  
  .tabs {
    display: flex;
    border-bottom: 1px solid #E5E5E5;
    background: #FFFFFF;
  }
  
  .tab {
    flex: 1;
    padding: 12px 16px;
    cursor: pointer;
    text-align: center;
    border: none;
    background: none;
    font-size: 11px;
    font-weight: 500;
    color: #8C8C8C;
    transition: all 0.2s;
  }
  
  .tab.active {
    color: #18A0FB;
    border-bottom: 2px solid #18A0FB;
  }
  
  .tab:hover {
    background: #F5F5F5;
  }
  
  .tab-content {
    display: none;
    height: calc(100vh - 45px);
    flex-direction: column;
  }
  
  .tab-content.active {
    display: flex;
  }
  
  .scrollable-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    padding-bottom: 16px;
    min-height: 0;
  }
  
  .bottom-buttons {
    padding: 12px 16px;
    background: white;
    border-top: 1px solid #E5E5E5;
    flex-shrink: 0;
    margin: 0;
  }
  
  .layout-list {
    margin-bottom: 0;
  }
  
  .layout-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    font-size: 11px;
  }
  
  .layout-item .checkbox {
    margin-right: 8px;
    width: 14px;
    height: 14px;
    cursor: pointer;
  }
  
  .layout-item .checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .layout-item .emoji {
    margin-right: 8px;
    font-size: 14px;
  }
  
  .layout-item.existing {
    opacity: 0.5;
    color: #8C8C8C;
  }
  
  .layout-item.existing .emoji {
    opacity: 0.6;
  }
  
  .separator-item-with-checkbox {
    display: flex;
    align-items: center;
    padding: 4px 0;
  }
  
  .separator-item-with-checkbox .checkbox {
    margin-right: 8px;
    width: 14px;
    height: 14px;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  .separator-item-with-checkbox .checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .separator-item-with-checkbox .separator-hr {
    flex: 1;
    margin: 0;
  }
  
  .create-btn {
    width: 100%;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin: 0;
  }
  
  .create-btn:hover {
    background: #0F7CE8;
  }
  
  .input-group {
    margin-bottom: 16px;
  }
  
  .input-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 11px;
    font-weight: 500;
    color: #333;
  }
  
  .input-group input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 11px;
    box-sizing: border-box;
  }
  
  .input-group input:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
  }
  
  .layout-editor {
    margin-bottom: 16px;
  }
  
  .editable-item {
    display: flex;
    align-items: center;
    padding: 8px;
    margin-bottom: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    background: #FAFAFA;
  }
  
  .emoji-selector {
    margin-right: 8px;
    padding: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    background: white;
  }
  
  .label-input {
    flex: 1;
    padding: 4px 6px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 11px;
  }
  
  .button-group {
    display: flex;
    gap: 8px;
    margin: 0;
  }
  
  .save-btn, .reset-btn {
    flex: 1;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin: 0;
  }
  
  .save-btn:hover, .reset-btn:hover {
    background: #0F7CE8;
  }
  
  .reset-btn {
    background: #6C7B7F;
  }
  
  .reset-btn:hover {
    background: #5A6B70;
  }
  
  .import-btn {
    width: 100%;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.2s;
  }
  
  .import-btn:hover {
    background: #0F7CE8;
  }
  
  .add-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #F0F0F0;
  }
  
  .add-page-btn, .add-separator-btn {
    flex: 1;
    padding: 8px 12px;
    background: #F8F8F8;
    color: #333;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .add-page-btn:hover, .add-separator-btn:hover {
    background: #E8F4FD;
    border-color: #18A0FB;
    color: #18A0FB;
  }
  
  .separator-hr {
    border: none;
    border-top: 1px solid #E5E5E5;
    margin: 8px 0;
    height: 1px;
  }
  
  .separator-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    margin-bottom: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    background: #F8F8F8;
  }
  
  .separator-label {
    flex: 1;
    font-size: 10px;
    color: #8C8C8C;
    font-style: italic;
    text-align: center;
  }
  
  .draggable {
    cursor: grab;
    transition: all 0.2s ease;
  }
  
  .draggable:active {
    cursor: grabbing;
  }
  
  .dragging {
    opacity: 0.5;
    transform: rotate(2deg);
  }
  
  .drop-indicator {
    position: relative;
  }
  
  .drop-indicator::before {
    content: '';
    position: absolute;
    left: -4px;
    right: -4px;
    height: 6px;
    background: rgba(24, 160, 251, 0.1);
    border: 1px dashed rgba(24, 160, 251, 0.4);
    border-radius: 3px;
    z-index: 1000;
    box-shadow: 0 0 8px rgba(24, 160, 251, 0.2);
  }
  
  .drop-indicator.top {
    margin-top: 6px;
  }
  
  .drop-indicator.top::before {
    top: -9px;
  }
  
  .drop-indicator.bottom {
    margin-bottom: 6px;
  }
  
  .drop-indicator.bottom::before {
    bottom: -9px;
  }
  
  .drag-handle {
    width: 16px;
    height: 16px;
    cursor: grab;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8C8C8C;
    font-size: 12px;
  }
  
  .drag-handle:active {
    cursor: grabbing;
  }
  
  .context-menu {
    position: fixed;
    background: white;
    border: 1px solid #E5E5E5;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 120px;
    display: none;
  }
  
  .context-menu-item {
    padding: 8px 12px;
    font-size: 11px;
    color: #333;
    cursor: pointer;
    border-bottom: 1px solid #F0F0F0;
  }
  
  .context-menu-item:last-child {
    border-bottom: none;
  }
  
  .context-menu-item:hover {
    background: #F5F5F5;
  }
  
  .context-menu-item.delete {
    color: #E74C3C;
  }
  
  .context-menu-item.delete:hover {
    background: #FDF2F2;
  }

  /* Emoji Picker Styles */
  .emoji-picker-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10001;
  }

  .emoji-picker-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    max-height: 400px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
  }

  .emoji-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #E5E5E5;
  }

  .emoji-picker-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  .emoji-picker-close {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .emoji-picker-close:hover {
    color: #333;
  }

  .emoji-picker-search {
    padding: 12px 16px;
    border-bottom: 1px solid #E5E5E5;
  }

  .emoji-picker-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    font-size: 12px;
    box-sizing: border-box;
  }

  .emoji-picker-search input:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
  }

  .emoji-picker-categories {
    display: flex;
    padding: 8px 12px;
    border-bottom: 1px solid #E5E5E5;
    gap: 4px;
    overflow-x: auto;
  }

  .category-btn {
    background: none;
    border: none;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    min-width: 32px;
    white-space: nowrap;
  }

  .category-btn:hover {
    background: #F0F0F0;
  }

  .category-btn.active {
    background: #18A0FB;
    color: white;
  }

  .emoji-picker-grid {
    padding: 12px;
    height: 200px;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }

  .emoji-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-size: 20px;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    background: none;
    transition: background 0.2s;
  }

  .emoji-item:hover {
    background: #F0F0F0;
  }

  .emoji-selector-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
    margin-right: 12px;
  }

  .emoji-selector-btn:hover {
    border-color: #18A0FB;
    background: #F8FCFF;
  }

  .import-export-section {
    margin-bottom: 24px;
  }

  .import-export-section h3 {
    margin: 0 0 16px 0;
    font-size: 13px;
    font-weight: 600;
    color: #333;
  }

  .file-select-btn {
    width: 100%;
    padding: 10px 16px;
    background: #6C7B7F;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 8px;
  }

  .file-select-btn:hover {
    background: #5A6B70;
  }

  .file-name {
    display: block;
    font-size: 10px;
    color: #666;
    margin-bottom: 8px;
    padding: 4px 0;
    min-height: 16px;
  }

  .export-section {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #F0F0F0;
  }

  .export-buttons {
    display: flex;
    gap: 8px;
  }

  .export-btn, .download-btn {
    flex: 1;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }

  .export-btn:hover, .download-btn:hover {
    background: #0F7CE8;
  }

  .download-btn {
    background: #6C7B7F;
  }

  .download-btn:hover {
    background: #5A6B70;
  }

  .export-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #E5E5E5;
    flex-shrink: 0;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #8C8C8C;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    color: #333;
  }

  .modal-body {
    flex: 1;
    padding: 20px;
    overflow: hidden;
  }

  .modal-body textarea {
    width: 100%;
    height: 100%;
    border: 1px solid #E5E5E5;
    border-radius: 6px;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 11px;
    line-height: 1.4;
    resize: none;
    box-sizing: border-box;
    background: #FAFAFA;
  }

  .modal-body textarea:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
  }

  .modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid #E5E5E5;
    flex-shrink: 0;
  }

  .copy-btn {
    flex: 1;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .copy-btn:hover {
    background: #0F7CE8;
  }

  .modal-close-btn {
    flex: 1;
    padding: 10px 16px;
    background: #6C7B7F;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .modal-close-btn:hover {
    background: #5A6B70;
  }

  .btn-loading {
    display: none;
    color: #8C8C8C;
  }

  .import-btn.loading .btn-text {
    display: none;
  }

  .import-btn.loading .btn-loading {
    display: inline;
  }

  /* Cover Component Settings */
  .cover-component-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #E5E5E5;
  }

  .cover-component-section h4 {
    margin: 0 0 12px 0;
    font-size: 12px;
    font-weight: 600;
    color: #333;
  }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .toggle-label {
    font-size: 11px;
    color: #333;
  }

  .toggle-switch {
    position: relative;
    width: 36px;
    height: 20px;
    display: inline-block;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 20px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  input:checked + .toggle-slider {
    background-color: #18A0FB;
  }

  input:checked + .toggle-slider:before {
    transform: translateX(16px);
  }

  .cover-component-config {
    margin-top: 12px;
  }

  .cover-component-config .input-group {
    margin-bottom: 8px;
  }

  .cover-component-config .input-group label {
    display: block;
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
  }

  .component-url-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    font-size: 11px;
    box-sizing: border-box;
  }

  .component-url-input:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
  }

  .component-url-input:disabled {
    background-color: #F5F5F5;
    color: #8C8C8C;
  }

  .preview-btn {
    width: 100%;
    padding: 8px 12px;
    background: #F8F8F8;
    color: #333;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }

  .preview-btn:hover:not(:disabled) {
    background: #E8F4FD;
    border-color: #18A0FB;
    color: #18A0FB;
  }

  .preview-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .preview-btn.loading .btn-text {
    display: none;
  }

  .preview-btn.loading .btn-loading {
    display: inline;
  }

  .component-preview {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: #F0FDF4;
    border: 1px solid #86EFAC;
    border-radius: 4px;
    margin-top: 8px;
  }

  .component-preview.error {
    background: #FEF2F2;
    border-color: #FCA5A5;
  }

  .preview-icon {
    margin-right: 8px;
    font-size: 14px;
  }

  .preview-text {
    font-size: 11px;
    color: #333;
  }

  .component-preview.error .preview-text {
    color: #DC2626;
  }

  .button-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .button-row .preview-btn,
  .button-row .get-key-btn {
    flex: 1;
    margin-top: 0;
  }

  .get-key-btn {
    padding: 8px 12px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .get-key-btn:hover {
    background: #0D8CE8;
  }

  .get-key-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .helper-text {
    font-size: 10px;
    color: #8C8C8C;
    margin-top: 12px;
    line-height: 1.4;
  }
</style>

<div class="tabs">
  <button class="tab active" data-tab="scaffold">Scaffold</button>
  <button class="tab" data-tab="settings">Settings</button>
  <button class="tab" data-tab="import-export">Import/Export</button>
</div>

<div class="tab-content active" id="scaffold-tab">
  <div class="scrollable-content">
    <div class="layout-list" id="layout-list">
      <!-- Layout items will be populated by JavaScript -->
    </div>
  </div>
  <div class="bottom-buttons">
    <button class="create-btn" id="create-btn">Create</button>
  </div>
</div>

<div class="tab-content" id="settings-tab">
  <div class="scrollable-content">
    <div class="layout-editor" id="layout-editor">
      <!-- Editable layout items will be populated by JavaScript -->
    </div>
    
    <div class="add-buttons">
      <button class="add-page-btn" id="add-page-btn">+ Add Page</button>
      <button class="add-separator-btn" id="add-separator-btn">+ Add Separator</button>
    </div>

    <div class="cover-component-section">
      <h4>Auto-Insert Cover Component</h4>

      <div class="toggle-row">
        <span class="toggle-label">Enable auto-insert on Cover page</span>
        <label class="toggle-switch">
          <input type="checkbox" id="cover-component-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div id="cover-component-config" class="cover-component-config" style="display: none;">
        <div class="input-group">
          <label for="component-key">Component Key</label>
          <input type="text" id="component-key" class="component-url-input" placeholder="Paste key or use button below">
        </div>

        <div class="button-row">
          <button class="get-key-btn" id="get-key-btn">
            <span class="btn-text">Get from Selection</span>
          </button>
          <button class="preview-btn" id="preview-component-btn">
            <span class="btn-text">Verify Key</span>
            <span class="btn-loading" style="display: none;">Loading...</span>
          </button>
        </div>

        <div id="component-preview-result"></div>

        <p class="helper-text">To get a component key: Open your library file, select the component, then click "Get from Selection".</p>
      </div>
    </div>
  </div>

  <div class="bottom-buttons">
    <div class="button-group">
      <button class="reset-btn" id="reset-btn">Reset</button>
      <button class="save-btn" id="save-btn">Save</button>
    </div>
  </div>
</div>

<div class="tab-content" id="import-export-tab">
  <div class="scrollable-content">
    <div class="import-export-section">
      <h3>Import Layout</h3>
      
      <div class="input-group">
        <label for="import-url">Import from URL</label>
        <input type="url" id="import-url" placeholder="https://example.com/layout.json">
        <button class="import-btn" id="import-url-btn">
          <span class="btn-text">Import</span>
          <span class="btn-loading" style="display: none;">Loading...</span>
        </button>
      </div>
      
      <div class="input-group">
        <label for="import-file">Import from File</label>
        <input type="file" id="import-file" accept=".json" style="display: none;">
        <button class="file-select-btn" id="file-select-btn">Choose File</button>
        <span class="file-name" id="file-name"></span>
        <button class="import-btn" id="import-file-btn" style="display: none;">
          <span class="btn-text">Import</span>
          <span class="btn-loading" style="display: none;">Loading...</span>
        </button>
      </div>
      
      <div class="export-section">
        <h3>Export Layout</h3>
        <div class="export-buttons">
          <button class="export-btn" id="export-btn">View JSON</button>
          <button class="download-btn" id="download-btn">Download JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="export-modal" id="export-modal" style="display: none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Export Layout</h3>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <textarea id="export-json" readonly></textarea>
    </div>
    <div class="modal-footer">
      <button class="copy-btn" id="copy-btn">Copy to Clipboard</button>
      <button class="modal-close-btn" id="modal-close-btn">Close</button>
    </div>
  </div>
</div>

<div class="context-menu" id="context-menu">
  <div class="context-menu-item" id="duplicate-item">Duplicate</div>
  <div class="context-menu-item delete" id="delete-item">Delete</div>
</div>

<div class="emoji-picker-modal" id="emoji-picker-modal" style="display: none;">
  <div class="modal-overlay"></div>
  <div class="emoji-picker-content">
    <div class="emoji-picker-header">
      <h3>Choose Emoji</h3>
      <button class="emoji-picker-close" id="emoji-picker-close">&times;</button>
    </div>
    <div class="emoji-picker-search">
      <input type="text" id="emoji-search" placeholder="Search emojis..." />
    </div>
    <div class="emoji-picker-categories">
      <button class="category-btn active" data-category="all">All</button>
      <button class="category-btn" data-category="faces">üòÄ</button>
      <button class="category-btn" data-category="animals">üê∂</button>
      <button class="category-btn" data-category="food">üçè</button>
      <button class="category-btn" data-category="activities">‚öΩ</button>
      <button class="category-btn" data-category="travel">üöó</button>
      <button class="category-btn" data-category="objects">‚åö</button>
      <button class="category-btn" data-category="symbols">‚ù§Ô∏è</button>
    </div>
    <div class="emoji-picker-grid" id="emoji-picker-grid">
      <!-- Emojis will be populated here -->
    </div>
  </div>
</div>

<script>
  // Original default layout data (for reset functionality)
  const originalLayoutData = [
    { emoji: 'üöß', label: 'Task or feature name', type: 'page' },
    { emoji: '‚îÄ', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', type: 'separator' },
    { emoji: 'üß©', label: 'Components', type: 'page' },
    { emoji: 'üìê', label: 'Specs', type: 'page' },
    { emoji: '‚îÄ', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', type: 'separator' },
    { emoji: 'üß†', label: 'Moodboard', type: 'page' },
    { emoji: 'üí°', label: 'Ideas', type: 'page' },
    { emoji: '‚ò£Ô∏è', label: 'Discarded', type: 'page' },
    { emoji: '‚îÄ', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', type: 'separator' },
    { emoji: 'üìÑ', label: 'Cover', type: 'page' }
  ];

  // Current layout data (can be modified)
  let layoutData = [...originalLayoutData];

  // Cover component settings state
  let coverComponentSettings = {
    componentKey: '',
    enabled: false,
    componentName: ''
  };

  // Emoji data with names and categories for search functionality
  const emojiData = [
    // Popular/Common emojis
    { emoji: 'üòÄ', name: 'grinning face', category: 'faces', keywords: ['happy', 'smile', 'grin'] },
    { emoji: 'üòÉ', name: 'grinning face with big eyes', category: 'faces', keywords: ['happy', 'smile', 'joy'] },
    { emoji: 'üòÑ', name: 'grinning face with smiling eyes', category: 'faces', keywords: ['happy', 'smile', 'laugh'] },
    { emoji: 'üòÅ', name: 'beaming face with smiling eyes', category: 'faces', keywords: ['happy', 'smile', 'grin'] },
    { emoji: 'üòä', name: 'smiling face with smiling eyes', category: 'faces', keywords: ['happy', 'smile', 'blush'] },
    { emoji: 'ü•∞', name: 'smiling face with hearts', category: 'faces', keywords: ['love', 'hearts', 'adore'] },
    { emoji: 'üòç', name: 'smiling face with heart-eyes', category: 'faces', keywords: ['love', 'heart', 'eyes'] },
    { emoji: 'ü§©', name: 'star-struck', category: 'faces', keywords: ['star', 'eyes', 'amazed'] },
    { emoji: 'üòò', name: 'face blowing a kiss', category: 'faces', keywords: ['kiss', 'love', 'heart'] },
    { emoji: 'üòã', name: 'face savoring food', category: 'faces', keywords: ['tongue', 'taste', 'delicious'] },
    { emoji: 'ü§î', name: 'thinking face', category: 'faces', keywords: ['think', 'consider', 'hmm'] },
    { emoji: 'üòé', name: 'smiling face with sunglasses', category: 'faces', keywords: ['cool', 'sunglasses', 'awesome'] },
    { emoji: 'ü§ì', name: 'nerd face', category: 'faces', keywords: ['nerd', 'glasses', 'geek'] },
    { emoji: 'üò¥', name: 'sleeping face', category: 'faces', keywords: ['sleep', 'tired', 'zzz'] },
    { emoji: 'üéâ', name: 'party popper', category: 'symbols', keywords: ['party', 'celebration', 'confetti'] },
    
    // Animals
    { emoji: 'üê∂', name: 'dog face', category: 'animals', keywords: ['dog', 'puppy', 'pet'] },
    { emoji: 'üê±', name: 'cat face', category: 'animals', keywords: ['cat', 'kitten', 'pet'] },
    { emoji: 'üê≠', name: 'mouse face', category: 'animals', keywords: ['mouse', 'rodent'] },
    { emoji: 'üêπ', name: 'hamster', category: 'animals', keywords: ['hamster', 'pet', 'rodent'] },
    { emoji: 'üê∞', name: 'rabbit face', category: 'animals', keywords: ['rabbit', 'bunny', 'easter'] },
    { emoji: 'ü¶ä', name: 'fox', category: 'animals', keywords: ['fox', 'clever', 'orange'] },
    { emoji: 'üêª', name: 'bear', category: 'animals', keywords: ['bear', 'teddy'] },
    { emoji: 'üêº', name: 'panda', category: 'animals', keywords: ['panda', 'bear', 'china'] },
    { emoji: 'üê®', name: 'koala', category: 'animals', keywords: ['koala', 'australia'] },
    { emoji: 'ü¶Å', name: 'lion', category: 'animals', keywords: ['lion', 'king', 'mane'] },
    { emoji: 'üê∏', name: 'frog', category: 'animals', keywords: ['frog', 'green', 'amphibian'] },
    { emoji: 'üêµ', name: 'monkey face', category: 'animals', keywords: ['monkey', 'ape', 'banana'] },
    { emoji: 'ü¶Ñ', name: 'unicorn', category: 'animals', keywords: ['unicorn', 'magical', 'horn'] },
    { emoji: 'üêù', name: 'honeybee', category: 'animals', keywords: ['bee', 'honey', 'buzz'] },
    { emoji: 'ü¶ã', name: 'butterfly', category: 'animals', keywords: ['butterfly', 'beautiful', 'wings'] },
    { emoji: 'üêû', name: 'lady beetle', category: 'animals', keywords: ['ladybug', 'insect', 'red'] },
    { emoji: 'üê¢', name: 'turtle', category: 'animals', keywords: ['turtle', 'slow', 'shell'] },
    { emoji: 'üêç', name: 'snake', category: 'animals', keywords: ['snake', 'reptile'] },
    { emoji: 'ü¶ñ', name: 'T-Rex', category: 'animals', keywords: ['dinosaur', 'trex', 'extinct'] },
    { emoji: 'üêô', name: 'octopus', category: 'animals', keywords: ['octopus', 'sea', 'tentacles'] },
    
    // Food
    { emoji: 'üçè', name: 'green apple', category: 'food', keywords: ['apple', 'fruit', 'green'] },
    { emoji: 'üçé', name: 'red apple', category: 'food', keywords: ['apple', 'fruit', 'red'] },
    { emoji: 'üçå', name: 'banana', category: 'food', keywords: ['banana', 'fruit', 'yellow'] },
    { emoji: 'üçâ', name: 'watermelon', category: 'food', keywords: ['watermelon', 'fruit', 'summer'] },
    { emoji: 'üçá', name: 'grapes', category: 'food', keywords: ['grapes', 'fruit', 'wine'] },
    { emoji: 'üçì', name: 'strawberry', category: 'food', keywords: ['strawberry', 'fruit', 'berry'] },
    { emoji: 'üçë', name: 'peach', category: 'food', keywords: ['peach', 'fruit'] },
    { emoji: 'üçç', name: 'pineapple', category: 'food', keywords: ['pineapple', 'fruit', 'tropical'] },
    { emoji: 'ü•ù', name: 'kiwi fruit', category: 'food', keywords: ['kiwi', 'fruit', 'green'] },
    { emoji: 'üçÖ', name: 'tomato', category: 'food', keywords: ['tomato', 'vegetable', 'red'] },
    { emoji: 'ü•ë', name: 'avocado', category: 'food', keywords: ['avocado', 'fruit', 'green'] },
    { emoji: 'üåΩ', name: 'ear of corn', category: 'food', keywords: ['corn', 'vegetable', 'yellow'] },
    { emoji: 'ü•ï', name: 'carrot', category: 'food', keywords: ['carrot', 'vegetable', 'orange'] },
    { emoji: 'üçû', name: 'bread', category: 'food', keywords: ['bread', 'loaf', 'bakery'] },
    { emoji: 'üßÄ', name: 'cheese wedge', category: 'food', keywords: ['cheese', 'dairy', 'yellow'] },
    { emoji: 'üçî', name: 'hamburger', category: 'food', keywords: ['burger', 'hamburger', 'fast food'] },
    { emoji: 'üçü', name: 'french fries', category: 'food', keywords: ['fries', 'potato', 'fast food'] },
    { emoji: 'üçï', name: 'pizza', category: 'food', keywords: ['pizza', 'slice', 'italian'] },
    { emoji: 'üå≠', name: 'hot dog', category: 'food', keywords: ['hot dog', 'sausage'] },
    { emoji: 'üéÇ', name: 'birthday cake', category: 'food', keywords: ['cake', 'birthday', 'celebration'] },
    
    // Activities
    { emoji: '‚öΩ', name: 'soccer ball', category: 'activities', keywords: ['soccer', 'football', 'ball'] },
    { emoji: 'üèÄ', name: 'basketball', category: 'activities', keywords: ['basketball', 'ball', 'sport'] },
    { emoji: 'üèà', name: 'american football', category: 'activities', keywords: ['football', 'american', 'ball'] },
    { emoji: '‚öæ', name: 'baseball', category: 'activities', keywords: ['baseball', 'ball', 'sport'] },
    { emoji: 'üéæ', name: 'tennis', category: 'activities', keywords: ['tennis', 'ball', 'racket'] },
    { emoji: 'üèê', name: 'volleyball', category: 'activities', keywords: ['volleyball', 'ball', 'sport'] },
    { emoji: 'üé±', name: 'pool 8 ball', category: 'activities', keywords: ['billiards', 'pool', '8ball'] },
    { emoji: 'üèì', name: 'ping pong', category: 'activities', keywords: ['ping pong', 'table tennis'] },
    { emoji: 'üè∏', name: 'badminton', category: 'activities', keywords: ['badminton', 'racket', 'shuttlecock'] },
    { emoji: 'ü•Ö', name: 'goal net', category: 'activities', keywords: ['goal', 'net', 'soccer'] },
    { emoji: 'üéØ', name: 'bullseye', category: 'activities', keywords: ['target', 'bullseye', 'dart'] },
    { emoji: 'üèπ', name: 'bow and arrow', category: 'activities', keywords: ['bow', 'arrow', 'archery'] },
    { emoji: 'üé£', name: 'fishing pole', category: 'activities', keywords: ['fishing', 'pole', 'fish'] },
    { emoji: 'ü•ä', name: 'boxing glove', category: 'activities', keywords: ['boxing', 'glove', 'fight'] },
    { emoji: 'üéÆ', name: 'video game', category: 'activities', keywords: ['game', 'controller', 'gaming'] },
    { emoji: 'üé≤', name: 'game die', category: 'activities', keywords: ['dice', 'game', 'random'] },
    { emoji: 'üé™', name: 'circus tent', category: 'activities', keywords: ['circus', 'tent', 'entertainment'] },
    { emoji: 'üé®', name: 'artist palette', category: 'activities', keywords: ['art', 'paint', 'palette'] },
    { emoji: 'üé≠', name: 'performing arts', category: 'activities', keywords: ['theater', 'drama', 'masks'] },
    { emoji: 'üéµ', name: 'musical note', category: 'activities', keywords: ['music', 'note', 'song'] },
    
    // Travel
    { emoji: 'üöó', name: 'automobile', category: 'travel', keywords: ['car', 'auto', 'vehicle'] },
    { emoji: 'üöï', name: 'taxi', category: 'travel', keywords: ['taxi', 'cab', 'yellow'] },
    { emoji: 'üöå', name: 'bus', category: 'travel', keywords: ['bus', 'public', 'transport'] },
    { emoji: 'üöé', name: 'trolleybus', category: 'travel', keywords: ['trolley', 'bus', 'transport'] },
    { emoji: 'üèé', name: 'racing car', category: 'travel', keywords: ['race', 'car', 'fast'] },
    { emoji: 'üöì', name: 'police car', category: 'travel', keywords: ['police', 'car', 'cop'] },
    { emoji: 'üöë', name: 'ambulance', category: 'travel', keywords: ['ambulance', 'medical', 'emergency'] },
    { emoji: 'üöí', name: 'fire engine', category: 'travel', keywords: ['fire', 'truck', 'emergency'] },
    { emoji: 'üöö', name: 'delivery truck', category: 'travel', keywords: ['truck', 'delivery', 'cargo'] },
    { emoji: 'üö≤', name: 'bicycle', category: 'travel', keywords: ['bike', 'bicycle', 'cycle'] },
    { emoji: '‚úàÔ∏è', name: 'airplane', category: 'travel', keywords: ['plane', 'airplane', 'flight'] },
    { emoji: 'üöÄ', name: 'rocket', category: 'travel', keywords: ['rocket', 'space', 'launch'] },
    { emoji: 'üöÅ', name: 'helicopter', category: 'travel', keywords: ['helicopter', 'chopper'] },
    { emoji: '‚õµ', name: 'sailboat', category: 'travel', keywords: ['boat', 'sail', 'water'] },
    { emoji: 'üö¢', name: 'ship', category: 'travel', keywords: ['ship', 'boat', 'cruise'] },
    { emoji: 'üè†', name: 'house', category: 'travel', keywords: ['house', 'home', 'building'] },
    { emoji: 'üè¢', name: 'office building', category: 'travel', keywords: ['office', 'building', 'work'] },
    { emoji: 'üè•', name: 'hospital', category: 'travel', keywords: ['hospital', 'medical', 'health'] },
    { emoji: 'üè´', name: 'school', category: 'travel', keywords: ['school', 'education', 'learn'] },
    { emoji: '‚õ™', name: 'church', category: 'travel', keywords: ['church', 'religion', 'worship'] },
    
    // Objects
    { emoji: 'üì±', name: 'mobile phone', category: 'objects', keywords: ['phone', 'mobile', 'cell'] },
    { emoji: 'üíª', name: 'laptop', category: 'objects', keywords: ['laptop', 'computer', 'pc'] },
    { emoji: '‚å®Ô∏è', name: 'keyboard', category: 'objects', keywords: ['keyboard', 'type', 'computer'] },
    { emoji: 'üñ•', name: 'desktop computer', category: 'objects', keywords: ['computer', 'desktop', 'monitor'] },
    { emoji: 'üñ®', name: 'printer', category: 'objects', keywords: ['printer', 'print', 'paper'] },
    { emoji: 'üì∑', name: 'camera', category: 'objects', keywords: ['camera', 'photo', 'picture'] },
    { emoji: 'üì∫', name: 'television', category: 'objects', keywords: ['tv', 'television', 'screen'] },
    { emoji: 'üìª', name: 'radio', category: 'objects', keywords: ['radio', 'music', 'broadcast'] },
    { emoji: '‚è∞', name: 'alarm clock', category: 'objects', keywords: ['clock', 'alarm', 'time'] },
    { emoji: 'üí°', name: 'light bulb', category: 'objects', keywords: ['bulb', 'light', 'idea'] },
    { emoji: 'üî¶', name: 'flashlight', category: 'objects', keywords: ['flashlight', 'torch', 'light'] },
    { emoji: 'üïØ', name: 'candle', category: 'objects', keywords: ['candle', 'flame', 'light'] },
    { emoji: 'üîß', name: 'wrench', category: 'objects', keywords: ['wrench', 'tool', 'fix'] },
    { emoji: 'üî®', name: 'hammer', category: 'objects', keywords: ['hammer', 'tool', 'nail'] },
    { emoji: '‚öôÔ∏è', name: 'gear', category: 'objects', keywords: ['gear', 'cog', 'settings'] },
    { emoji: 'üî©', name: 'nut and bolt', category: 'objects', keywords: ['bolt', 'nut', 'screw'] },
    { emoji: 'üîë', name: 'key', category: 'objects', keywords: ['key', 'lock', 'unlock'] },
    { emoji: 'üîí', name: 'locked', category: 'objects', keywords: ['lock', 'secure', 'private'] },
    { emoji: 'üîì', name: 'unlocked', category: 'objects', keywords: ['unlock', 'open', 'access'] },
    { emoji: 'üìù', name: 'memo', category: 'objects', keywords: ['memo', 'note', 'write'] },
    
    // Symbols
    { emoji: '‚ù§Ô∏è', name: 'red heart', category: 'symbols', keywords: ['heart', 'love', 'red'] },
    { emoji: 'üíõ', name: 'yellow heart', category: 'symbols', keywords: ['heart', 'love', 'yellow'] },
    { emoji: 'üíö', name: 'green heart', category: 'symbols', keywords: ['heart', 'love', 'green'] },
    { emoji: 'üíô', name: 'blue heart', category: 'symbols', keywords: ['heart', 'love', 'blue'] },
    { emoji: 'üíú', name: 'purple heart', category: 'symbols', keywords: ['heart', 'love', 'purple'] },
    { emoji: '‚≠ê', name: 'star', category: 'symbols', keywords: ['star', 'favorite', 'rating'] },
    { emoji: 'üåü', name: 'glowing star', category: 'symbols', keywords: ['star', 'glow', 'sparkle'] },
    { emoji: '‚úÖ', name: 'check mark', category: 'symbols', keywords: ['check', 'mark', 'correct'] },
    { emoji: '‚ùå', name: 'cross mark', category: 'symbols', keywords: ['cross', 'x', 'wrong'] },
    { emoji: '‚ö†Ô∏è', name: 'warning', category: 'symbols', keywords: ['warning', 'caution', 'alert'] },
    { emoji: 'üöß', name: 'construction', category: 'symbols', keywords: ['construction', 'work', 'caution'] },
    { emoji: 'üî•', name: 'fire', category: 'symbols', keywords: ['fire', 'flame', 'hot'] },
    { emoji: 'üíß', name: 'droplet', category: 'symbols', keywords: ['water', 'drop', 'liquid'] },
    { emoji: '‚ö°', name: 'high voltage', category: 'symbols', keywords: ['lightning', 'electricity', 'power'] },
    { emoji: 'üíØ', name: 'hundred points', category: 'symbols', keywords: ['hundred', '100', 'perfect'] },
    { emoji: '‚ú®', name: 'sparkles', category: 'symbols', keywords: ['sparkle', 'magic', 'shine'] },
    { emoji: 'üåà', name: 'rainbow', category: 'symbols', keywords: ['rainbow', 'colors', 'pride'] },
    { emoji: '‚òÄÔ∏è', name: 'sun', category: 'symbols', keywords: ['sun', 'sunny', 'bright'] },
    { emoji: 'üß©', name: 'puzzle piece', category: 'symbols', keywords: ['puzzle', 'piece', 'component'] },
    { emoji: 'üìÑ', name: 'page facing up', category: 'symbols', keywords: ['page', 'document', 'paper'] },
    { emoji: 'üìê', name: 'triangular ruler', category: 'symbols', keywords: ['ruler', 'triangle', 'measure'] },
    { emoji: 'üß†', name: 'brain', category: 'symbols', keywords: ['brain', 'mind', 'think'] },
    { emoji: '‚ò£Ô∏è', name: 'biohazard', category: 'symbols', keywords: ['biohazard', 'danger', 'toxic'] },
    { emoji: 'üß™', name: 'test tube', category: 'symbols', keywords: ['test', 'tube', 'science'] },
    { emoji: 'üìä', name: 'bar chart', category: 'symbols', keywords: ['chart', 'graph', 'data'] },
    { emoji: '‚îÄ', name: 'separator', category: 'symbols', keywords: ['separator', 'line', 'divider'] }
  ];

  // Create emojiOptions array for backwards compatibility
  const emojiOptions = emojiData.map(item => item.emoji);

  // Store existing pages from Figma
  let existingPages = [];

  // Context menu variables
  let contextMenuTargetIndex = null;
  const contextMenu = document.getElementById('context-menu');

  // Context menu functions
  function showContextMenu(x, y, index) {
    contextMenuTargetIndex = index;
    contextMenu.style.display = 'block';
    
    // Get menu dimensions
    const menuRect = contextMenu.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Adjust position if menu goes beyond viewport
    let adjustedX = x;
    let adjustedY = y;
    
    if (x + menuRect.width > viewportWidth) {
      adjustedX = x - menuRect.width;
    }
    
    if (y + menuRect.height > viewportHeight) {
      adjustedY = y - menuRect.height;
    }
    
    contextMenu.style.left = adjustedX + 'px';
    contextMenu.style.top = adjustedY + 'px';
  }

  function hideContextMenu() {
    contextMenu.style.display = 'none';
    contextMenuTargetIndex = null;
  }

  // Hide context menu when clicking outside or pressing escape
  document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target)) {
      hideContextMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && contextMenu.style.display === 'block') {
      hideContextMenu();
    }
  });

  // Tab switching functionality
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Update active content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Request existing pages when switching to scaffold tab
      if (tabName === 'scaffold') {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'getExistingPages'
          } 
        }, '*');
      }
    });
  });

  // Render layout list in scaffold tab
  function renderLayoutList() {
    const layoutList = document.getElementById('layout-list');
    layoutList.innerHTML = '';
    
    layoutData.forEach((item, index) => {
      if (item.type === 'separator') {
        const div = document.createElement('div');
        div.className = 'separator-item-with-checkbox';
        
        // Check if separator page "---" already exists
        const isExisting = existingPages.includes('---');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.id = `separator-${index}`;
        checkbox.checked = !isExisting; // Default checked if not existing
        checkbox.disabled = isExisting;
        
        if (isExisting) {
          div.style.opacity = '0.5';
        }
        
        div.appendChild(checkbox);
        
        // Add separator line
        const hr = document.createElement('hr');
        hr.className = 'separator-hr';
        div.appendChild(hr);
        
        layoutList.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.className = 'layout-item';
        
        // Check if this page already exists in Figma
        const pageName = item.emoji + ' - ' + item.label;
        const isExisting = existingPages.includes(pageName);
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.id = `page-${index}`;
        checkbox.checked = !isExisting; // Default checked if not existing
        checkbox.disabled = isExisting;
        
        if (isExisting) {
          div.classList.add('existing');
        }
        
        div.innerHTML = `
          <span class="emoji">${item.emoji}</span>
          <span>${item.label}</span>
        `;
        
        // Insert checkbox at the beginning
        div.insertBefore(checkbox, div.firstChild);
        
        layoutList.appendChild(div);
      }
    });
  }

  // Drag and drop variables
  let draggedIndex = null;
  let dropPosition = null; // 'before' or 'after'
  let dropTargetIndex = null;

  // Helper function to clear all drop indicators
  function clearDropIndicators() {
    const items = document.querySelectorAll('.draggable');
    items.forEach(item => {
      item.classList.remove('drop-indicator', 'top', 'bottom');
    });
  }

  // Helper function to show drop indicator
  function showDropIndicator(element, position) {
    clearDropIndicators();
    element.classList.add('drop-indicator', position);
  }

  // Render editable layout in settings tab
  function renderLayoutEditor() {
    const layoutEditor = document.getElementById('layout-editor');
    layoutEditor.innerHTML = '';
    
    layoutData.forEach((item, index) => {
      if (item.type === 'separator') {
        const div = document.createElement('div');
        div.className = 'separator-item draggable';
        div.draggable = true;
        div.dataset.index = index;
        
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '‚ãÆ‚ãÆ';
        
        // Prevent context menu on drag handle
        dragHandle.addEventListener('contextmenu', (e) => {
          e.stopPropagation();
        });
        
        const label = document.createElement('span');
        label.className = 'separator-label';
        label.textContent = 'Separator (creates "---" page in Figma)';
        
        div.appendChild(dragHandle);
        div.appendChild(label);
        
        // Add drag and drop event listeners
        addDragListeners(div, index);
        
        // Add right-click context menu
        div.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(e.clientX, e.clientY, index);
        });
        
        layoutEditor.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.className = 'editable-item draggable';
        div.draggable = true;
        div.dataset.index = index;
        
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '‚ãÆ‚ãÆ';
        
        // Prevent context menu on drag handle
        dragHandle.addEventListener('contextmenu', (e) => {
          e.stopPropagation();
        });
        
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'emoji-selector-btn';
        emojiBtn.textContent = item.emoji;
        emojiBtn.type = 'button';
        
        // Open emoji picker when clicked
        emojiBtn.addEventListener('click', () => {
          openEmojiPicker((selectedEmoji) => {
            const currentIndex = parseInt(div.dataset.index);
            layoutData[currentIndex].emoji = selectedEmoji;
            emojiBtn.textContent = selectedEmoji;
            renderLayoutList(); // Update scaffold tab
          });
        });
        
        const labelInput = document.createElement('input');
        labelInput.className = 'label-input';
        labelInput.type = 'text';
        labelInput.value = item.label;
        
        labelInput.addEventListener('input', () => {
          const currentIndex = parseInt(div.dataset.index);
          layoutData[currentIndex].label = labelInput.value;
          renderLayoutList(); // Update scaffold tab
        });
        
        div.appendChild(dragHandle);
        div.appendChild(emojiBtn);
        div.appendChild(labelInput);
        
        // Add drag and drop event listeners
        addDragListeners(div, index);
        
        // Add right-click context menu
        div.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(e.clientX, e.clientY, index);
        });
        
        layoutEditor.appendChild(div);
      }
    });
  }

  // Add drag and drop event listeners to an element
  function addDragListeners(element, index) {
    element.addEventListener('dragstart', (e) => {
      draggedIndex = index;
      element.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', element.outerHTML);
    });

    element.addEventListener('dragend', (e) => {
      element.classList.remove('dragging');
      clearDropIndicators();
      draggedIndex = null;
      dropPosition = null;
      dropTargetIndex = null;
    });

    element.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (draggedIndex === null) return;
      
      const rect = element.getBoundingClientRect();
      const mouseY = e.clientY;
      const elementMiddle = rect.top + rect.height / 2;
      
      const currentIndex = parseInt(element.dataset.index);
      dropTargetIndex = currentIndex;
      
      if (mouseY < elementMiddle) {
        // Dragging over top half - insert before
        dropPosition = 'before';
        showDropIndicator(element, 'top');
      } else {
        // Dragging over bottom half - insert after
        dropPosition = 'after';
        showDropIndicator(element, 'bottom');
      }
    });

    element.addEventListener('dragleave', (e) => {
      // Only clear if we're actually leaving the element (not entering a child)
      if (!element.contains(e.relatedTarget)) {
        clearDropIndicators();
        dropPosition = null;
        dropTargetIndex = null;
      }
    });

    element.addEventListener('drop', (e) => {
      e.preventDefault();
      clearDropIndicators();
      
      if (draggedIndex !== null && dropTargetIndex !== null && dropPosition !== null) {
        let insertIndex;
        
        if (dropPosition === 'before') {
          insertIndex = dropTargetIndex;
        } else { // 'after'
          insertIndex = dropTargetIndex + 1;
        }
        
        // Adjust insert index if dragging from above
        if (draggedIndex < insertIndex) {
          insertIndex--;
        }
        
        if (draggedIndex !== insertIndex) {
          // Reorder the array
          const draggedItem = layoutData[draggedIndex];
          layoutData.splice(draggedIndex, 1);
          layoutData.splice(insertIndex, 0, draggedItem);
          
          // Re-render both tabs
          renderLayoutEditor();
          renderLayoutList();
        }
        
        dropPosition = null;
        dropTargetIndex = null;
      }
    });
  }

  // Message handler for plugin responses
  window.addEventListener('message', (event) => {
    if (event.data.pluginMessage?.type === 'layoutLoaded') {
      layoutData = event.data.pluginMessage.layoutData;
      renderLayoutList();
      renderLayoutEditor();
    } else if (event.data.pluginMessage?.type === 'existingPagesLoaded') {
      existingPages = event.data.pluginMessage.existingPages;
      renderLayoutList();
    } else if (event.data.pluginMessage?.type === 'coverComponentSettingsLoaded') {
      const settings = event.data.pluginMessage.settings;
      if (settings) {
        coverComponentSettings = settings;
        document.getElementById('cover-component-toggle').checked = settings.enabled;
        document.getElementById('cover-component-config').style.display = settings.enabled ? 'block' : 'none';

        if (settings.componentKey) {
          // Show the stored component key
          document.getElementById('component-key').value = settings.componentKey;

          if (settings.componentName) {
            showPreviewResult(true, settings.componentName);
          }
        }
      }
    } else if (event.data.pluginMessage?.type === 'coverComponentPreviewResult') {
      const btn = document.getElementById('preview-component-btn');
      btn.classList.remove('loading');
      btn.disabled = false;

      const result = event.data.pluginMessage.result;
      if (result.success) {
        coverComponentSettings.componentName = result.name;
        showPreviewResult(true, result.name);
      } else {
        showPreviewResult(false, result.error);
      }
    } else if (event.data.pluginMessage?.type === 'selectedComponentKey') {
      const msg = event.data.pluginMessage;
      if (msg.success) {
        // Fill in the component key input
        document.getElementById('component-key').value = msg.componentKey;
        coverComponentSettings.componentKey = msg.componentKey;
        coverComponentSettings.componentName = msg.componentName;
        showPreviewResult(true, msg.componentName);
      } else {
        showPreviewResult(false, msg.error);
      }
    }
  });

  // Initialize the interface
  renderLayoutList();
  renderLayoutEditor();

  // Load saved layout data and existing pages on startup
  parent.postMessage({ 
    pluginMessage: { 
      type: 'loadLayout'
    } 
  }, '*');

  parent.postMessage({
    pluginMessage: {
      type: 'getExistingPages'
    }
  }, '*');

  // Load cover component settings on startup
  parent.postMessage({
    pluginMessage: {
      type: 'loadCoverComponentSettings'
    }
  }, '*');

  // Create button functionality
  document.getElementById('create-btn').addEventListener('click', () => {
    // Get selected pages only
    const selectedPages = [];
    
    layoutData.forEach((item, index) => {
      let checkbox;
      if (item.type === 'separator') {
        checkbox = document.getElementById(`separator-${index}`);
      } else {
        checkbox = document.getElementById(`page-${index}`);
      }
      
      if (checkbox && checkbox.checked) {
        selectedPages.push(item);
      }
    });
    
    if (selectedPages.length === 0) {
      alert('Please select at least one page to create.');
      return;
    }
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'createPages',
        layoutData: selectedPages
      } 
    }, '*');
  });


  // Save functionality
  document.getElementById('save-btn').addEventListener('click', () => {
    // Save layout
    parent.postMessage({
      pluginMessage: {
        type: 'saveLayout',
        layoutData: layoutData
      }
    }, '*');

    // Save cover component settings
    parent.postMessage({
      pluginMessage: {
        type: 'saveCoverComponentSettings',
        settings: coverComponentSettings
      }
    }, '*');
  });

  // Reset functionality
  document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('Are you sure you want to reset to the original layout? This will discard all your changes.')) {
      layoutData = [...originalLayoutData];
      renderLayoutList();
      renderLayoutEditor();
    }
  });

  // Add page functionality
  document.getElementById('add-page-btn').addEventListener('click', () => {
    const newPage = {
      emoji: 'üìÑ',
      label: 'New Page',
      type: 'page'
    };
    layoutData.push(newPage);
    renderLayoutList();
    renderLayoutEditor();
  });

  // Add separator functionality
  document.getElementById('add-separator-btn').addEventListener('click', () => {
    const newSeparator = {
      emoji: '‚îÄ',
      label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
      type: 'separator'
    };
    layoutData.push(newSeparator);
    renderLayoutList();
    renderLayoutEditor();
  });

  // Context menu functionality
  document.getElementById('duplicate-item').addEventListener('click', () => {
    if (contextMenuTargetIndex !== null) {
      const itemToDuplicate = { ...layoutData[contextMenuTargetIndex] };
      // Insert the duplicate right after the original
      layoutData.splice(contextMenuTargetIndex + 1, 0, itemToDuplicate);
      renderLayoutList();
      renderLayoutEditor();
      hideContextMenu();
    }
  });

  document.getElementById('delete-item').addEventListener('click', () => {
    if (contextMenuTargetIndex !== null) {
      if (confirm('Are you sure you want to delete this item?')) {
        layoutData.splice(contextMenuTargetIndex, 1);
        renderLayoutList();
        renderLayoutEditor();
      }
      hideContextMenu();
    }
  });

  // Import/Export Tab Functionality
  
  // File selection functionality
  document.getElementById('file-select-btn').addEventListener('click', () => {
    document.getElementById('import-file').click();
  });

  document.getElementById('import-file').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const fileName = document.getElementById('file-name');
    const importBtn = document.getElementById('import-file-btn');
    
    if (file) {
      fileName.textContent = file.name;
      importBtn.style.display = 'block';
    } else {
      fileName.textContent = '';
      importBtn.style.display = 'none';
    }
  });

  // Helper function to show confirmation dialog
  function showImportConfirmation(callback) {
    if (confirm('Do you want to replace the actual layout?')) {
      callback();
    }
  }

  // Helper function to redirect to settings tab
  function redirectToSettings() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="settings"]').classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById('settings-tab').classList.add('active');
  }

  // URL Import functionality
  document.getElementById('import-url-btn').addEventListener('click', async () => {
    const url = document.getElementById('import-url').value;
    if (!url) return;

    const button = document.getElementById('import-url-btn');
    button.classList.add('loading');
    
    try {
      const response = await fetch(url);
      const importedData = await response.json();
      
      button.classList.remove('loading');
      
      if (Array.isArray(importedData) && importedData.every(item => item.emoji && item.label)) {
        showImportConfirmation(() => {
          // Ensure imported data has type property, default to 'page' if missing
          layoutData = importedData.map(item => ({
            ...item,
            type: item.type || (item.emoji === '‚îÄ' ? 'separator' : 'page')
          }));
          renderLayoutList();
          renderLayoutEditor();
          redirectToSettings();
        });
      } else {
        alert('Invalid JSON format. Expected array of objects with emoji and label properties.');
      }
    } catch (error) {
      button.classList.remove('loading');
      alert('Failed to import layout: ' + error.message);
    }
  });

  // File Import functionality
  document.getElementById('import-file-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) return;

    const button = document.getElementById('import-file-btn');
    button.classList.add('loading');
    
    try {
      const text = await file.text();
      const importedData = JSON.parse(text);
      
      button.classList.remove('loading');
      
      if (Array.isArray(importedData) && importedData.every(item => item.emoji && item.label)) {
        showImportConfirmation(() => {
          // Ensure imported data has type property, default to 'page' if missing
          layoutData = importedData.map(item => ({
            ...item,
            type: item.type || (item.emoji === '‚îÄ' ? 'separator' : 'page')
          }));
          renderLayoutList();
          renderLayoutEditor();
          
          // Clear file input
          fileInput.value = '';
          document.getElementById('file-name').textContent = '';
          button.style.display = 'none';
          
          redirectToSettings();
        });
      } else {
        alert('Invalid JSON format. Expected array of objects with emoji and label properties.');
      }
    } catch (error) {
      button.classList.remove('loading');
      alert('Failed to import layout: ' + error.message);
    }
  });

  // Export functionality
  document.getElementById('export-btn').addEventListener('click', () => {
    const modal = document.getElementById('export-modal');
    const textarea = document.getElementById('export-json');
    
    // Format the layout data as JSON
    const exportData = JSON.stringify(layoutData, null, 2);
    textarea.value = exportData;
    
    modal.style.display = 'block';
  });

  // Download functionality
  document.getElementById('download-btn').addEventListener('click', () => {
    // Format the layout data as JSON
    const exportData = JSON.stringify(layoutData, null, 2);
    
    // Create a blob with the JSON data
    const blob = new Blob([exportData], { type: 'application/json' });
    
    // Create a temporary URL for the blob
    const url = URL.createObjectURL(blob);
    
    // Create a temporary anchor element and trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = 'figma-layout.json';
    document.body.appendChild(a);
    a.click();
    
    // Clean up
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Modal close functionality
  function closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
  }

  document.getElementById('modal-close').addEventListener('click', closeExportModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeExportModal);
  
  // Close modal when clicking overlay
  document.querySelector('.modal-overlay').addEventListener('click', closeExportModal);

  // Copy to clipboard functionality
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const textarea = document.getElementById('export-json');
    
    try {
      await navigator.clipboard.writeText(textarea.value);
      
      // Temporarily change button text to show success
      const button = document.getElementById('copy-btn');
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.style.background = '#10B981';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '#18A0FB';
      }, 2000);
    } catch (error) {
      // Fallback for older browsers
      textarea.select();
      document.execCommand('copy');
      
      const button = document.getElementById('copy-btn');
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.style.background = '#10B981';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '#18A0FB';
      }, 2000);
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('export-modal').style.display === 'block') {
      closeExportModal();
    }
    if (e.key === 'Escape' && document.getElementById('emoji-picker-modal').style.display === 'block') {
      closeEmojiPicker();
    }
  });

  // Emoji Picker Functionality
  let emojiPickerCallback = null;
  let currentEmojiFilter = 'all';

  function openEmojiPicker(callback) {
    emojiPickerCallback = callback;
    const modal = document.getElementById('emoji-picker-modal');
    modal.style.display = 'block';
    
    // Reset search and category
    document.getElementById('emoji-search').value = '';
    currentEmojiFilter = 'all';
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-category="all"]').classList.add('active');
    
    renderEmojiGrid();
    
    // Focus search input
    setTimeout(() => {
      document.getElementById('emoji-search').focus();
    }, 100);
  }

  function closeEmojiPicker() {
    document.getElementById('emoji-picker-modal').style.display = 'none';
    emojiPickerCallback = null;
  }

  function renderEmojiGrid() {
    const grid = document.getElementById('emoji-picker-grid');
    const searchTerm = document.getElementById('emoji-search').value.toLowerCase();
    
    let filteredEmojis = emojiData;
    
    // Filter by category
    if (currentEmojiFilter !== 'all') {
      filteredEmojis = filteredEmojis.filter(item => item.category === currentEmojiFilter);
    }
    
    // Filter by search term
    if (searchTerm) {
      filteredEmojis = filteredEmojis.filter(item => 
        item.name.toLowerCase().includes(searchTerm) ||
        item.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm)) ||
        item.emoji.includes(searchTerm)
      );
    }
    
    // Clear grid
    grid.innerHTML = '';
    
    // Add filtered emojis
    filteredEmojis.forEach(item => {
      const button = document.createElement('button');
      button.className = 'emoji-item';
      button.textContent = item.emoji;
      button.title = item.name;
      
      button.addEventListener('click', () => {
        if (emojiPickerCallback) {
          emojiPickerCallback(item.emoji);
        }
        closeEmojiPicker();
      });
      
      grid.appendChild(button);
    });
    
    // Show message if no results
    if (filteredEmojis.length === 0) {
      const message = document.createElement('div');
      message.style.gridColumn = '1 / -1';
      message.style.textAlign = 'center';
      message.style.color = '#666';
      message.style.fontSize = '12px';
      message.style.padding = '20px';
      message.textContent = 'No emojis found';
      grid.appendChild(message);
    }
  }

  // Emoji picker event listeners
  document.getElementById('emoji-picker-close').addEventListener('click', closeEmojiPicker);
  document.querySelector('#emoji-picker-modal .modal-overlay').addEventListener('click', closeEmojiPicker);

  document.getElementById('emoji-search').addEventListener('input', renderEmojiGrid);

  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active category
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      currentEmojiFilter = btn.dataset.category;
      renderEmojiGrid();
    });
  });

  // Cover component feature helper functions
  function showPreviewResult(success, message) {
    const resultDiv = document.getElementById('component-preview-result');
    resultDiv.style.display = 'block';

    if (success) {
      resultDiv.innerHTML = `
        <div class="component-preview">
          <span class="preview-icon">&#10003;</span>
          <span class="preview-text">Found: <strong>${message}</strong></span>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="component-preview error">
          <span class="preview-icon">&#10007;</span>
          <span class="preview-text">${message}</span>
        </div>
      `;
    }
  }

  // Cover component toggle handler
  document.getElementById('cover-component-toggle').addEventListener('change', (e) => {
    const configSection = document.getElementById('cover-component-config');
    configSection.style.display = e.target.checked ? 'block' : 'none';
    coverComponentSettings.enabled = e.target.checked;
  });

  // Cover component preview button handler (Verify Key)
  document.getElementById('preview-component-btn').addEventListener('click', () => {
    const keyInput = document.getElementById('component-key');
    const componentKey = keyInput.value.trim();

    if (!componentKey) {
      showPreviewResult(false, 'Please enter a component key or use "Get from Selection"');
      return;
    }

    // Store the component key
    coverComponentSettings.componentKey = componentKey;

    // Show loading state
    const btn = document.getElementById('preview-component-btn');
    btn.classList.add('loading');
    btn.disabled = true;

    // Request preview from plugin
    parent.postMessage({
      pluginMessage: {
        type: 'previewCoverComponent',
        componentKey: componentKey
      }
    }, '*');
  });

  // Get component key from selection button handler
  document.getElementById('get-key-btn').addEventListener('click', () => {
    parent.postMessage({
      pluginMessage: {
        type: 'getSelectedComponentKey'
      }
    }, '*');
  });
</script>