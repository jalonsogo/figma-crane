<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/figma-plugin-ds.css">
<style>
  body {
    padding: 0;
    margin: 0;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
  }
  
  .tabs {
    display: flex;
    border-bottom: 1px solid #E5E5E5;
    background: #FFFFFF;
  }
  
  .tab {
    flex: 1;
    padding: 12px 16px;
    cursor: pointer;
    text-align: center;
    border: none;
    background: none;
    font-size: 11px;
    font-weight: 500;
    color: #8C8C8C;
    transition: all 0.2s;
  }
  
  .tab.active {
    color: #18A0FB;
    border-bottom: 2px solid #18A0FB;
  }
  
  .tab:hover {
    background: #F5F5F5;
  }
  
  .tab-content {
    display: none;
    height: calc(100vh - 85px);
    flex-direction: column;
  }
  
  .tab-content.active {
    display: flex;
  }
  
  .scrollable-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    padding-bottom: 16px;
    min-height: 0;
  }
  
  .bottom-buttons {
    padding: 12px 16px;
    background: white;
    border-top: 1px solid #E5E5E5;
    flex-shrink: 0;
    margin: 0;
  }
  
  .layout-list {
    margin-bottom: 0;
  }
  
  .layout-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    font-size: 11px;
  }
  
  .layout-item .checkbox {
    margin-right: 8px;
    width: 14px;
    height: 14px;
    cursor: pointer;
  }
  
  .layout-item .checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .layout-item .emoji {
    margin-right: 8px;
    font-size: 14px;
  }
  
  .layout-item.existing {
    opacity: 0.5;
    color: #8C8C8C;
  }
  
  .layout-item.existing .emoji {
    opacity: 0.6;
  }
  
  .separator-item-with-checkbox {
    display: flex;
    align-items: center;
    padding: 4px 0;
  }
  
  .separator-item-with-checkbox .checkbox {
    margin-right: 8px;
    width: 14px;
    height: 14px;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  .separator-item-with-checkbox .checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .separator-item-with-checkbox .separator-hr {
    flex: 1;
    margin: 0;
  }
  
  .create-btn {
    width: 100%;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin: 0;
  }
  
  .create-btn:hover {
    background: #0F7CE8;
  }
  
  .input-group {
    margin-bottom: 16px;
  }
  
  .input-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 11px;
    font-weight: 500;
    color: #333;
  }
  
  .input-group input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 11px;
    box-sizing: border-box;
  }
  
  .input-group input:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
  }
  
  .layout-editor {
    margin-bottom: 16px;
  }
  
  .editable-item {
    display: flex;
    align-items: center;
    padding: 8px;
    margin-bottom: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    background: #FAFAFA;
  }
  
  .emoji-selector {
    margin-right: 8px;
    padding: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    background: white;
  }
  
  .label-input {
    flex: 1;
    padding: 4px 6px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 11px;
  }
  
  .button-group {
    display: flex;
    gap: 8px;
    margin: 0;
  }
  
  .save-btn, .reset-btn {
    flex: 1;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin: 0;
  }
  
  .save-btn:hover, .reset-btn:hover {
    background: #0F7CE8;
  }
  
  .reset-btn {
    background: #6C7B7F;
  }
  
  .reset-btn:hover {
    background: #5A6B70;
  }
  
  .import-btn {
    width: 100%;
    padding: 6px 12px;
    background: #7C3AED;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.2s;
  }
  
  .import-btn:hover {
    background: #6D28D9;
  }
  
  .add-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #F0F0F0;
  }
  
  .add-page-btn, .add-separator-btn {
    flex: 1;
    padding: 8px 12px;
    background: #F8F8F8;
    color: #333;
    border: 1px solid #E5E5E5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .add-page-btn:hover, .add-separator-btn:hover {
    background: #E8F4FD;
    border-color: #18A0FB;
    color: #18A0FB;
  }
  
  .separator-hr {
    border: none;
    border-top: 1px solid #E5E5E5;
    margin: 8px 0;
    height: 1px;
  }
  
  .separator-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    margin-bottom: 4px;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    background: #F8F8F8;
  }
  
  .separator-label {
    flex: 1;
    font-size: 10px;
    color: #8C8C8C;
    font-style: italic;
    text-align: center;
  }
  
  .draggable {
    cursor: grab;
    transition: all 0.2s ease;
  }
  
  .draggable:active {
    cursor: grabbing;
  }
  
  .dragging {
    opacity: 0.5;
    transform: rotate(2deg);
  }
  
  .drop-indicator {
    position: relative;
  }
  
  .drop-indicator::before {
    content: '';
    position: absolute;
    left: -4px;
    right: -4px;
    height: 6px;
    background: rgba(24, 160, 251, 0.1);
    border: 1px dashed rgba(24, 160, 251, 0.4);
    border-radius: 3px;
    z-index: 1000;
    box-shadow: 0 0 8px rgba(24, 160, 251, 0.2);
  }
  
  .drop-indicator.top {
    margin-top: 6px;
  }
  
  .drop-indicator.top::before {
    top: -9px;
  }
  
  .drop-indicator.bottom {
    margin-bottom: 6px;
  }
  
  .drop-indicator.bottom::before {
    bottom: -9px;
  }
  
  .drag-handle {
    width: 16px;
    height: 16px;
    cursor: grab;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8C8C8C;
    font-size: 12px;
  }
  
  .drag-handle:active {
    cursor: grabbing;
  }
  
  .context-menu {
    position: fixed;
    background: white;
    border: 1px solid #E5E5E5;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 120px;
    display: none;
  }
  
  .context-menu-item {
    padding: 8px 12px;
    font-size: 11px;
    color: #333;
    cursor: pointer;
    border-bottom: 1px solid #F0F0F0;
  }
  
  .context-menu-item:last-child {
    border-bottom: none;
  }
  
  .context-menu-item:hover {
    background: #F5F5F5;
  }
  
  .context-menu-item.delete {
    color: #E74C3C;
  }
  
  .context-menu-item.delete:hover {
    background: #FDF2F2;
  }

  .import-export-section {
    margin-bottom: 24px;
  }

  .import-export-section h3 {
    margin: 0 0 16px 0;
    font-size: 13px;
    font-weight: 600;
    color: #333;
  }

  .file-select-btn {
    width: 100%;
    padding: 6px 12px;
    background: #F8F8F8;
    color: #333;
    border: 1px solid #E5E5E5;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
  }

  .file-select-btn:hover {
    background: #E8F4FD;
    border-color: #18A0FB;
    color: #18A0FB;
  }

  .file-name {
    display: block;
    font-size: 10px;
    color: #666;
    margin-bottom: 8px;
    padding: 4px 0;
    min-height: 16px;
  }

  .export-section {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #F0F0F0;
  }

  .export-btn {
    width: 100%;
    padding: 10px 16px;
    background: #10B981;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .export-btn:hover {
    background: #059669;
  }

  .export-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #E5E5E5;
    flex-shrink: 0;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #8C8C8C;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    color: #333;
  }

  .modal-body {
    flex: 1;
    padding: 20px;
    overflow: hidden;
  }

  .modal-body textarea {
    width: 100%;
    height: 100%;
    border: 1px solid #E5E5E5;
    border-radius: 6px;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 11px;
    line-height: 1.4;
    resize: none;
    box-sizing: border-box;
    background: #FAFAFA;
  }

  .modal-body textarea:focus {
    outline: none;
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
  }

  .modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid #E5E5E5;
    flex-shrink: 0;
  }

  .copy-btn {
    flex: 1;
    padding: 10px 16px;
    background: #18A0FB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .copy-btn:hover {
    background: #0F7CE8;
  }

  .modal-close-btn {
    flex: 1;
    padding: 10px 16px;
    background: #6C7B7F;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .modal-close-btn:hover {
    background: #5A6B70;
  }

  .btn-loading {
    display: none;
    color: #8C8C8C;
  }

  .import-btn.loading .btn-text {
    display: none;
  }

  .import-btn.loading .btn-loading {
    display: inline;
  }
</style>

<div class="tabs">
  <button class="tab active" data-tab="scaffold">Scaffold</button>
  <button class="tab" data-tab="settings">Settings</button>
  <button class="tab" data-tab="import-export">Import/Export</button>
</div>

<div class="tab-content active" id="scaffold-tab">
  <div class="scrollable-content">
    <div class="layout-list" id="layout-list">
      <!-- Layout items will be populated by JavaScript -->
    </div>
  </div>
  <div class="bottom-buttons">
    <button class="create-btn" id="create-btn">Create</button>
  </div>
</div>

<div class="tab-content" id="settings-tab">
  <div class="scrollable-content">
    <div class="layout-editor" id="layout-editor">
      <!-- Editable layout items will be populated by JavaScript -->
    </div>
    
    <div class="add-buttons">
      <button class="add-page-btn" id="add-page-btn">+ Add Page</button>
      <button class="add-separator-btn" id="add-separator-btn">+ Add Separator</button>
    </div>
  </div>
  
  <div class="bottom-buttons">
    <div class="button-group">
      <button class="reset-btn" id="reset-btn">Reset</button>
      <button class="save-btn" id="save-btn">Save</button>
    </div>
  </div>
</div>

<div class="tab-content" id="import-export-tab">
  <div class="scrollable-content">
    <div class="import-export-section">
      <h3>Import Layout</h3>
      
      <div class="input-group">
        <label for="import-url">Import from URL</label>
        <input type="url" id="import-url" placeholder="https://example.com/layout.json">
        <button class="import-btn" id="import-url-btn">
          <span class="btn-text">Import</span>
          <span class="btn-loading" style="display: none;">Loading...</span>
        </button>
      </div>
      
      <div class="input-group">
        <label for="import-file">Import from File</label>
        <input type="file" id="import-file" accept=".json" style="display: none;">
        <button class="file-select-btn" id="file-select-btn">Choose File</button>
        <span class="file-name" id="file-name"></span>
        <button class="import-btn" id="import-file-btn" style="display: none;">
          <span class="btn-text">Import</span>
          <span class="btn-loading" style="display: none;">Loading...</span>
        </button>
      </div>
      
      <div class="export-section">
        <h3>Export Layout</h3>
        <button class="export-btn" id="export-btn">Export Layout</button>
      </div>
    </div>
  </div>
</div>

<div class="export-modal" id="export-modal" style="display: none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Export Layout</h3>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <textarea id="export-json" readonly></textarea>
    </div>
    <div class="modal-footer">
      <button class="copy-btn" id="copy-btn">Copy to Clipboard</button>
      <button class="modal-close-btn" id="modal-close-btn">Close</button>
    </div>
  </div>
</div>

<div class="context-menu" id="context-menu">
  <div class="context-menu-item" id="duplicate-item">Duplicate</div>
  <div class="context-menu-item delete" id="delete-item">Delete</div>
</div>

<script>
  // Original default layout data (for reset functionality)
  const originalLayoutData = [
    { emoji: 'ðŸš§', label: 'Task or feature name', type: 'page' },
    { emoji: 'â”€', label: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', type: 'separator' },
    { emoji: 'ðŸ§©', label: 'Components', type: 'page' },
    { emoji: 'ðŸ“', label: 'Specs', type: 'page' },
    { emoji: 'â”€', label: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', type: 'separator' },
    { emoji: 'ðŸ§ ', label: 'Moodboard', type: 'page' },
    { emoji: 'ðŸ’¡', label: 'Ideas', type: 'page' },
    { emoji: 'â˜£ï¸', label: 'Discarded', type: 'page' },
    { emoji: 'â”€', label: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', type: 'separator' },
    { emoji: 'ðŸ“„', label: 'Cover', type: 'page' }
  ];

  // Current layout data (can be modified)
  let layoutData = [...originalLayoutData];

  // Common emojis for the selector
  const emojiOptions = ['ðŸš§', 'ðŸ§©', 'ðŸ“', 'ðŸ§ ', 'ðŸ’¡', 'â˜£ï¸', 'ðŸ“„', 'ðŸŽ¨', 'ðŸ“', 'ðŸ§ª', 'ðŸ”§', 'ðŸ’»', 'ðŸ“Š', 'ðŸŽ¯', 'âœ¨', 'â”€'];

  // Store existing pages from Figma
  let existingPages = [];

  // Context menu variables
  let contextMenuTargetIndex = null;
  const contextMenu = document.getElementById('context-menu');

  // Context menu functions
  function showContextMenu(x, y, index) {
    contextMenuTargetIndex = index;
    contextMenu.style.display = 'block';
    
    // Get menu dimensions
    const menuRect = contextMenu.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Adjust position if menu goes beyond viewport
    let adjustedX = x;
    let adjustedY = y;
    
    if (x + menuRect.width > viewportWidth) {
      adjustedX = x - menuRect.width;
    }
    
    if (y + menuRect.height > viewportHeight) {
      adjustedY = y - menuRect.height;
    }
    
    contextMenu.style.left = adjustedX + 'px';
    contextMenu.style.top = adjustedY + 'px';
  }

  function hideContextMenu() {
    contextMenu.style.display = 'none';
    contextMenuTargetIndex = null;
  }

  // Hide context menu when clicking outside or pressing escape
  document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target)) {
      hideContextMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && contextMenu.style.display === 'block') {
      hideContextMenu();
    }
  });

  // Tab switching functionality
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Update active content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Request existing pages when switching to scaffold tab
      if (tabName === 'scaffold') {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'getExistingPages'
          } 
        }, '*');
      }
    });
  });

  // Render layout list in scaffold tab
  function renderLayoutList() {
    const layoutList = document.getElementById('layout-list');
    layoutList.innerHTML = '';
    
    layoutData.forEach((item, index) => {
      if (item.type === 'separator') {
        const div = document.createElement('div');
        div.className = 'separator-item-with-checkbox';
        
        // Check if separator page "---" already exists
        const isExisting = existingPages.includes('---');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.id = `separator-${index}`;
        checkbox.checked = !isExisting; // Default checked if not existing
        checkbox.disabled = isExisting;
        
        if (isExisting) {
          div.style.opacity = '0.5';
        }
        
        div.appendChild(checkbox);
        
        // Add separator line
        const hr = document.createElement('hr');
        hr.className = 'separator-hr';
        div.appendChild(hr);
        
        layoutList.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.className = 'layout-item';
        
        // Check if this page already exists in Figma
        const pageName = item.emoji + ' - ' + item.label;
        const isExisting = existingPages.includes(pageName);
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.id = `page-${index}`;
        checkbox.checked = !isExisting; // Default checked if not existing
        checkbox.disabled = isExisting;
        
        if (isExisting) {
          div.classList.add('existing');
        }
        
        div.innerHTML = `
          <span class="emoji">${item.emoji}</span>
          <span>${item.label}</span>
        `;
        
        // Insert checkbox at the beginning
        div.insertBefore(checkbox, div.firstChild);
        
        layoutList.appendChild(div);
      }
    });
  }

  // Drag and drop variables
  let draggedIndex = null;
  let dropPosition = null; // 'before' or 'after'
  let dropTargetIndex = null;

  // Helper function to clear all drop indicators
  function clearDropIndicators() {
    const items = document.querySelectorAll('.draggable');
    items.forEach(item => {
      item.classList.remove('drop-indicator', 'top', 'bottom');
    });
  }

  // Helper function to show drop indicator
  function showDropIndicator(element, position) {
    clearDropIndicators();
    element.classList.add('drop-indicator', position);
  }

  // Render editable layout in settings tab
  function renderLayoutEditor() {
    const layoutEditor = document.getElementById('layout-editor');
    layoutEditor.innerHTML = '';
    
    layoutData.forEach((item, index) => {
      if (item.type === 'separator') {
        const div = document.createElement('div');
        div.className = 'separator-item draggable';
        div.draggable = true;
        div.dataset.index = index;
        
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = 'â‹®â‹®';
        
        // Prevent context menu on drag handle
        dragHandle.addEventListener('contextmenu', (e) => {
          e.stopPropagation();
        });
        
        const label = document.createElement('span');
        label.className = 'separator-label';
        label.textContent = 'Separator (creates "---" page in Figma)';
        
        div.appendChild(dragHandle);
        div.appendChild(label);
        
        // Add drag and drop event listeners
        addDragListeners(div, index);
        
        // Add right-click context menu
        div.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(e.clientX, e.clientY, index);
        });
        
        layoutEditor.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.className = 'editable-item draggable';
        div.draggable = true;
        div.dataset.index = index;
        
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = 'â‹®â‹®';
        
        // Prevent context menu on drag handle
        dragHandle.addEventListener('contextmenu', (e) => {
          e.stopPropagation();
        });
        
        const emojiSelect = document.createElement('select');
        emojiSelect.className = 'emoji-selector';
        emojiOptions.forEach(emoji => {
          const option = document.createElement('option');
          option.value = emoji;
          option.textContent = emoji;
          if (emoji === item.emoji) option.selected = true;
          emojiSelect.appendChild(option);
        });
        
        const labelInput = document.createElement('input');
        labelInput.className = 'label-input';
        labelInput.type = 'text';
        labelInput.value = item.label;
        
        // Update data when changed
        emojiSelect.addEventListener('change', () => {
          const currentIndex = parseInt(div.dataset.index);
          layoutData[currentIndex].emoji = emojiSelect.value;
          renderLayoutList(); // Update scaffold tab
        });
        
        labelInput.addEventListener('input', () => {
          const currentIndex = parseInt(div.dataset.index);
          layoutData[currentIndex].label = labelInput.value;
          renderLayoutList(); // Update scaffold tab
        });
        
        div.appendChild(dragHandle);
        div.appendChild(emojiSelect);
        div.appendChild(labelInput);
        
        // Add drag and drop event listeners
        addDragListeners(div, index);
        
        // Add right-click context menu
        div.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(e.clientX, e.clientY, index);
        });
        
        layoutEditor.appendChild(div);
      }
    });
  }

  // Add drag and drop event listeners to an element
  function addDragListeners(element, index) {
    element.addEventListener('dragstart', (e) => {
      draggedIndex = index;
      element.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', element.outerHTML);
    });

    element.addEventListener('dragend', (e) => {
      element.classList.remove('dragging');
      clearDropIndicators();
      draggedIndex = null;
      dropPosition = null;
      dropTargetIndex = null;
    });

    element.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (draggedIndex === null) return;
      
      const rect = element.getBoundingClientRect();
      const mouseY = e.clientY;
      const elementMiddle = rect.top + rect.height / 2;
      
      const currentIndex = parseInt(element.dataset.index);
      dropTargetIndex = currentIndex;
      
      if (mouseY < elementMiddle) {
        // Dragging over top half - insert before
        dropPosition = 'before';
        showDropIndicator(element, 'top');
      } else {
        // Dragging over bottom half - insert after
        dropPosition = 'after';
        showDropIndicator(element, 'bottom');
      }
    });

    element.addEventListener('dragleave', (e) => {
      // Only clear if we're actually leaving the element (not entering a child)
      if (!element.contains(e.relatedTarget)) {
        clearDropIndicators();
        dropPosition = null;
        dropTargetIndex = null;
      }
    });

    element.addEventListener('drop', (e) => {
      e.preventDefault();
      clearDropIndicators();
      
      if (draggedIndex !== null && dropTargetIndex !== null && dropPosition !== null) {
        let insertIndex;
        
        if (dropPosition === 'before') {
          insertIndex = dropTargetIndex;
        } else { // 'after'
          insertIndex = dropTargetIndex + 1;
        }
        
        // Adjust insert index if dragging from above
        if (draggedIndex < insertIndex) {
          insertIndex--;
        }
        
        if (draggedIndex !== insertIndex) {
          // Reorder the array
          const draggedItem = layoutData[draggedIndex];
          layoutData.splice(draggedIndex, 1);
          layoutData.splice(insertIndex, 0, draggedItem);
          
          // Re-render both tabs
          renderLayoutEditor();
          renderLayoutList();
        }
        
        dropPosition = null;
        dropTargetIndex = null;
      }
    });
  }

  // Message handler for plugin responses
  window.addEventListener('message', (event) => {
    if (event.data.pluginMessage?.type === 'layoutLoaded') {
      layoutData = event.data.pluginMessage.layoutData;
      renderLayoutList();
      renderLayoutEditor();
    } else if (event.data.pluginMessage?.type === 'existingPagesLoaded') {
      existingPages = event.data.pluginMessage.existingPages;
      renderLayoutList();
    }
  });

  // Initialize the interface
  renderLayoutList();
  renderLayoutEditor();

  // Load saved layout data and existing pages on startup
  parent.postMessage({ 
    pluginMessage: { 
      type: 'loadLayout'
    } 
  }, '*');

  parent.postMessage({ 
    pluginMessage: { 
      type: 'getExistingPages'
    } 
  }, '*');

  // Create button functionality
  document.getElementById('create-btn').addEventListener('click', () => {
    // Get selected pages only
    const selectedPages = [];
    
    layoutData.forEach((item, index) => {
      let checkbox;
      if (item.type === 'separator') {
        checkbox = document.getElementById(`separator-${index}`);
      } else {
        checkbox = document.getElementById(`page-${index}`);
      }
      
      if (checkbox && checkbox.checked) {
        selectedPages.push(item);
      }
    });
    
    if (selectedPages.length === 0) {
      alert('Please select at least one page to create.');
      return;
    }
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'createPages',
        layoutData: selectedPages
      } 
    }, '*');
  });


  // Save functionality
  document.getElementById('save-btn').addEventListener('click', () => {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'saveLayout',
        layoutData: layoutData
      } 
    }, '*');
  });

  // Reset functionality
  document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('Are you sure you want to reset to the original layout? This will discard all your changes.')) {
      layoutData = [...originalLayoutData];
      renderLayoutList();
      renderLayoutEditor();
    }
  });

  // Add page functionality
  document.getElementById('add-page-btn').addEventListener('click', () => {
    const newPage = {
      emoji: 'ðŸ“„',
      label: 'New Page',
      type: 'page'
    };
    layoutData.push(newPage);
    renderLayoutList();
    renderLayoutEditor();
  });

  // Add separator functionality
  document.getElementById('add-separator-btn').addEventListener('click', () => {
    const newSeparator = {
      emoji: 'â”€',
      label: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
      type: 'separator'
    };
    layoutData.push(newSeparator);
    renderLayoutList();
    renderLayoutEditor();
  });

  // Context menu functionality
  document.getElementById('duplicate-item').addEventListener('click', () => {
    if (contextMenuTargetIndex !== null) {
      const itemToDuplicate = { ...layoutData[contextMenuTargetIndex] };
      // Insert the duplicate right after the original
      layoutData.splice(contextMenuTargetIndex + 1, 0, itemToDuplicate);
      renderLayoutList();
      renderLayoutEditor();
      hideContextMenu();
    }
  });

  document.getElementById('delete-item').addEventListener('click', () => {
    if (contextMenuTargetIndex !== null) {
      if (confirm('Are you sure you want to delete this item?')) {
        layoutData.splice(contextMenuTargetIndex, 1);
        renderLayoutList();
        renderLayoutEditor();
      }
      hideContextMenu();
    }
  });

  // Import/Export Tab Functionality
  
  // File selection functionality
  document.getElementById('file-select-btn').addEventListener('click', () => {
    document.getElementById('import-file').click();
  });

  document.getElementById('import-file').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const fileName = document.getElementById('file-name');
    const importBtn = document.getElementById('import-file-btn');
    
    if (file) {
      fileName.textContent = file.name;
      importBtn.style.display = 'block';
    } else {
      fileName.textContent = '';
      importBtn.style.display = 'none';
    }
  });

  // Helper function to show confirmation dialog
  function showImportConfirmation(callback) {
    if (confirm('Do you want to replace the actual layout?')) {
      callback();
    }
  }

  // Helper function to redirect to settings tab
  function redirectToSettings() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="settings"]').classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById('settings-tab').classList.add('active');
  }

  // URL Import functionality
  document.getElementById('import-url-btn').addEventListener('click', async () => {
    const url = document.getElementById('import-url').value;
    if (!url) return;

    const button = document.getElementById('import-url-btn');
    button.classList.add('loading');
    
    try {
      const response = await fetch(url);
      const importedData = await response.json();
      
      button.classList.remove('loading');
      
      if (Array.isArray(importedData) && importedData.every(item => item.emoji && item.label)) {
        showImportConfirmation(() => {
          // Ensure imported data has type property, default to 'page' if missing
          layoutData = importedData.map(item => ({
            ...item,
            type: item.type || (item.emoji === 'â”€' ? 'separator' : 'page')
          }));
          renderLayoutList();
          renderLayoutEditor();
          redirectToSettings();
        });
      } else {
        alert('Invalid JSON format. Expected array of objects with emoji and label properties.');
      }
    } catch (error) {
      button.classList.remove('loading');
      alert('Failed to import layout: ' + error.message);
    }
  });

  // File Import functionality
  document.getElementById('import-file-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) return;

    const button = document.getElementById('import-file-btn');
    button.classList.add('loading');
    
    try {
      const text = await file.text();
      const importedData = JSON.parse(text);
      
      button.classList.remove('loading');
      
      if (Array.isArray(importedData) && importedData.every(item => item.emoji && item.label)) {
        showImportConfirmation(() => {
          // Ensure imported data has type property, default to 'page' if missing
          layoutData = importedData.map(item => ({
            ...item,
            type: item.type || (item.emoji === 'â”€' ? 'separator' : 'page')
          }));
          renderLayoutList();
          renderLayoutEditor();
          
          // Clear file input
          fileInput.value = '';
          document.getElementById('file-name').textContent = '';
          button.style.display = 'none';
          
          redirectToSettings();
        });
      } else {
        alert('Invalid JSON format. Expected array of objects with emoji and label properties.');
      }
    } catch (error) {
      button.classList.remove('loading');
      alert('Failed to import layout: ' + error.message);
    }
  });

  // Export functionality
  document.getElementById('export-btn').addEventListener('click', () => {
    const modal = document.getElementById('export-modal');
    const textarea = document.getElementById('export-json');
    
    // Format the layout data as JSON
    const exportData = JSON.stringify(layoutData, null, 2);
    textarea.value = exportData;
    
    modal.style.display = 'block';
  });

  // Modal close functionality
  function closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
  }

  document.getElementById('modal-close').addEventListener('click', closeExportModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeExportModal);
  
  // Close modal when clicking overlay
  document.querySelector('.modal-overlay').addEventListener('click', closeExportModal);

  // Copy to clipboard functionality
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const textarea = document.getElementById('export-json');
    
    try {
      await navigator.clipboard.writeText(textarea.value);
      
      // Temporarily change button text to show success
      const button = document.getElementById('copy-btn');
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.style.background = '#10B981';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '#18A0FB';
      }, 2000);
    } catch (error) {
      // Fallback for older browsers
      textarea.select();
      document.execCommand('copy');
      
      const button = document.getElementById('copy-btn');
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.style.background = '#10B981';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '#18A0FB';
      }, 2000);
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('export-modal').style.display === 'block') {
      closeExportModal();
    }
  });
</script>